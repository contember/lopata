# Bunflare - Project Status

## Overview

| Metric           | Value |
| ---------------- | ----- |
| **Total Issues** | 39    |
| **Completed**    | 39    |
| **Pending**      | 0     |
| **Progress**     | 100%  |

## Current Focus

All issues completed. Project at 100%.

## Issues

### Phase 1 — Core Implementation (completed)

| #  | Issue                        | Status    | Notes |
| -- | ---------------------------- | --------- | ----- |
| 00 | persistence-layer            | completed | Foundation — db.ts, schema, .bunflare/ dir |
| 14 | migrate-kv-to-sqlite         | completed | KV from in-memory Map to SQLite |
| 15 | migrate-r2-to-files          | completed | R2 from in-memory Map to files + SQLite metadata |
| 16 | migrate-do-storage-to-sqlite | completed | DO storage from in-memory Map to SQLite |
| 17 | migrate-workflows-to-sqlite  | completed | Workflow binding to SQLite |
| 07 | environment-variables        | completed | Parse vars from config + .dev.vars |
| 01 | d1-database                  | completed | |
| 02 | queues                       | completed | |
| 03 | service-bindings             | completed | |
| 04 | scheduled-handler            | completed | |
| 05 | static-assets                | completed | |
| 06 | cache-api                    | completed | |
| 08 | workflow-instance-management | completed | |
| 09 | images-binding               | completed | |
| 13 | do-misc                      | completed | |
| 10 | do-alarms                    | completed | |
| 11 | do-websocket-support         | completed | |
| 12 | do-sql-storage               | completed | |

### Phase 2 — API Completeness (completed)

Issues ordered by priority — high-impact gaps first, optional/low-priority last.

| #  | Issue                        | Status  | Notes |
| -- | ---------------------------- | ------- | ----- |
| 27 | do-gaps                      | completed | Stub fetch(), list startAfter, sync(), WS validation |
| 18 | kv-gaps                      | completed | Bulk ops, key/value/metadata validation, configurable limits |
| 20 | d1-gaps                      | completed | dump(), exec() parsing, type conversion, meta accuracy |
| 21 | queues-gaps                  | completed | Content types, validation, attempts fix, waitUntil |
| 23 | cache-api-gaps               | completed | TTL/expiration, Cache-Control, cf-cache-status, validation, limits |
| 26 | workflows-gaps               | completed | Step retry, checkpointing, status structure, queued, retention, concurrency |
| 19 | r2-gaps                      | completed | Multipart, conditionals, range reads, list delimiter, validation, R2Object props |
| 24 | static-assets-gaps           | completed | ETag, Cache-Control, _headers, run_worker_first, 307 fix, hierarchical 404 |
| 22 | service-bindings-gaps        | completed | RPC property access, async consistency, subrequest limits, TCP stub |
| 28 | config-gaps                  | completed | wrangler.toml, env-specific config, global env import |
| 29 | scheduled-gaps               | completed | Special cron strings, day/month names, controller.type |
| 25 | images-transforms            | completed | Sharp-based transforms, AVIF dimensions, draw overlay, quality |

### Phase 3 — Remaining API Gaps (pending)

Issues ordered by priority — high-impact first.

| #  | Issue                        | Status  | Priority  | Notes |
| -- | ---------------------------- | ------- | --------- | ----- |
| 30 | html-rewriter                | completed | medium    | HTMLRewriter class via html-rewriter-wasm (lol-html WASM) |
| 31 | websocket-pair               | completed | medium    | WebSocketPair + WS upgrade for regular Workers |
| 32 | cf-streams                   | completed | low       | IdentityTransformStream, FixedLengthStream |
| 33 | do-sync-kv                   | completed | low       | storage.kv.get/put/delete/list (synchronous) |
| 34 | redirects-file               | completed | low       | _redirects file: static/dynamic redirects, splats, placeholders, rewrite |
| 35 | crypto-extras                | completed | very low  | crypto.subtle.timingSafeEqual, crypto.DigestStream |
| 36 | navigator-globals            | completed | very low  | navigator.userAgent, navigator.language, performance.timeOrigin, scheduler.wait |
| 37 | queue-pull-consumers         | completed | low       | HTTP pull/ack endpoints for queues |
| 38 | do-transaction-sync          | completed | low       | storage.transactionSync() |

## Dependencies

### Phase 1
- **00** must be completed first (shared DB singleton, schema, data directory)
- **14, 15, 16, 17** (migrations) depend on **00** — do these right after 00
- **08** (workflow management) depends on **17** (workflow persistence)
- **10, 11, 12, 13** (DO features) depend on **16** (DO persistence)
- All new binding issues (01-06, 09) depend on **00**

### Phase 2
- No hard dependencies between Phase 2 issues — can be implemented in any order
- All Phase 2 issues depend on their respective Phase 1 implementation being completed (already done)
- **25** (images-transforms) requires `sharp` as an optional dependency

### Phase 3
- **38** (do-transaction-sync) pairs with **33** (do-sync-kv) — implement together
- **31** (websocket-pair) is independent — no dependency on other Phase 3 issues
- **30** (html-rewriter) is independent — requires external dependency (lol-html WASM)
- All other Phase 3 issues are independent

## Changelog

- **#00 persistence-layer**: Created `runtime/db.ts` with `getDatabase()` singleton, `runMigrations()` for all 7 tables (kv, r2_objects, do_storage, do_alarms, queue_messages, workflow_instances, cache_entries), WAL mode, auto-creation of `.bunflare/` directory structure. Added `runtime/tests/db.test.ts` with 9 tests.
- **#14 migrate-kv-to-sqlite**: Replaced `InMemoryKVNamespace` with `SqliteKVNamespace` backed by SQLite `kv` table. Constructor takes `(db, namespace)`. Values stored as BLOB, metadata as JSON string. Expiration checked on `get()`/`getWithMetadata()`, lazily cleaned on `list()`. Cursor-based pagination in `list()`. Updated `env.ts` to pass `getDatabase()` and binding name. Added namespace isolation test and cursor pagination test. All 89 tests pass.
- **#15 migrate-r2-to-files**: Replaced `InMemoryR2Bucket` with `FileR2Bucket`. Blobs stored as files under `.bunflare/r2/<bucket>/<key>`, metadata in `r2_objects` SQLite table. Constructor takes `(db, bucket, dataDir)`. Etag generated via MD5 hash. Nested keys with `/` create subdirectories. Path traversal (`..`) rejected. Cursor-based pagination via OFFSET. Updated `env.ts` to pass `getDatabase()`, bucket name, and `getDataDir()`. Added tests for nested keys, etag, path traversal, bucket isolation, cursor pagination, and persistence across instances. All 95 tests pass.
- **#16 migrate-do-storage-to-sqlite**: Replaced `InMemoryDurableObjectStorage` with `SqliteDurableObjectStorage` backed by `do_storage` table. Constructor takes `(db, namespace, id)`. Values stored as JSON strings. Added `deleteAll()` method and full `list()` with `prefix`, `start`, `end`, `limit`, `reverse` options. `transaction()` wraps in real SQLite BEGIN/COMMIT/ROLLBACK. `DurableObjectStateImpl` now takes `(id, db, namespace)`. `DurableObjectNamespaceImpl` takes `(db, namespaceName)`. Updated `env.ts` to pass `getDatabase()` and class name. Added tests for namespace/instance isolation, persistence across instances, `deleteAll`, `list` with `start`/`end`/`reverse`, empty arrays. All 104 tests pass.
- **#17 migrate-workflows-to-sqlite**: Replaced `InMemoryWorkflowBinding` with `SqliteWorkflowBinding` backed by `workflow_instances` table. Constructor takes `(db, workflowName, className)`. Params/output stored as JSON. `create()` inserts row with `running` status and executes workflow in background; on completion updates to `complete` with output, on error updates to `errored` with message. Added `get(id)` to retrieve instance handle from DB. `SqliteWorkflowInstance` provides `status()`, `pause()`, `resume()`, `terminate()` (with AbortController), and `restart()`. `WorkflowStepImpl` checks abort signal before each step. Updated `env.ts` to pass `db`, workflow name, class name. Tests cover persistence, status lifecycle, terminate, pause/resume, cross-instance retrieval, custom IDs. All 112 tests pass.

- **#01 d1-database**: Implemented `LocalD1Database` and `LocalD1PreparedStatement` in `runtime/bindings/d1.ts`. Each D1 binding gets its own SQLite file at `.bunflare/d1/<database_name>.sqlite`, separate from the main `data.sqlite`. `prepare()` returns a statement with `bind()`, `first()`, `run()`, `all()`, `raw()`. `batch()` wraps all statements in a BEGIN/COMMIT transaction with ROLLBACK on error. `exec()` splits multi-statement SQL on `;` and runs each. `withSession()` is a no-op returning self. `raw({ columnNames: true })` prepends column names array. Added `d1_databases` to `WranglerConfig`. Wired in `env.ts` via `openD1Database()`. Added 18 tests covering all methods, batch rollback, persistence, bind immutability. All 143 tests pass.

- **#07 environment-variables**: Added `vars` field to `WranglerConfig`. Implemented `parseDevVars()` in `env.ts` to parse dotenv-style `.dev.vars` files (supports comments, quoted values, whitespace trimming). `buildEnv()` now accepts optional `devVarsPath` parameter — config `vars` are injected first, then `.dev.vars` overrides them (matching wrangler behavior). Updated `dev.ts` to pass `.dev.vars` path. Added 13 tests (8 for parser, 5 for buildEnv integration). All 125 tests pass.

- **#02 queues**: Implemented `SqliteQueueProducer` and `QueueConsumer` in `runtime/bindings/queue.ts`. Producer: `send()` inserts message into `queue_messages` table with `visible_at` = now + delay, `sendBatch()` inserts multiple in a transaction. Consumer: `poll()` selects visible messages up to `maxBatchSize`, calls worker's `queue()` handler with `MessageBatch`. Messages auto-ack by default (matching CF behavior). `ack()`/`ackAll()` deletes messages, `retry()`/`retryAll()` keeps them with updated `visible_at`. After `maxRetries`, messages move to DLQ (if configured) or are discarded. Handler errors trigger retry for all messages. Added `queues` config (producers + consumers) to `WranglerConfig`. Wired producers in `env.ts`, consumers started in `dev.ts` via `setInterval` poll loop. Added 18 tests covering send, sendBatch, delay, batch size, ack/retry, DLQ, handler errors, persistence, attempts tracking. All 164 tests pass.

- **#04 scheduled-handler**: Implemented `parseCron()` and `cronMatchesDate()` in `runtime/bindings/scheduled.ts` — a lightweight cron parser supporting wildcards, specific values, ranges, comma-separated values, and step values (`*/5`, `1-10/3`). `ScheduledController` provides `scheduledTime`, `cron`, and `noRetry()` (no-op in dev). `startCronScheduler()` sets up a 60-second interval that checks all cron expressions against the current time and calls the worker's `scheduled()` handler on match. Added `triggers.crons` to `WranglerConfig`. In `dev.ts`: cron scheduler starts after worker import; `GET /__scheduled?cron=<expr>` endpoint allows manual triggering (matching wrangler dev behavior). Added 18 tests covering cron parsing (wildcards, specifics, ranges, commas, steps, invalid expressions), date matching (minute, hour, day, month, weekday, every-5-min, midnight), and ScheduledController properties. All 198 tests pass.

- **#03 service-bindings**: Implemented `ServiceBinding` class and `createServiceBinding()` factory in `runtime/bindings/service-binding.ts`. Binding is a Proxy that supports both HTTP mode (`.fetch()` calls target worker's fetch handler in-process) and RPC mode (any other property access returns an async function calling the method on the target). Supports named entrypoints via `entrypoint` config — instantiates the exported class with `env` and proxies method calls to it. Updated `WorkerEntrypoint` in `plugin.ts` to be a proper base class with `env` and `ctx` properties. Added `services` config to `WranglerConfig`. Wired in `env.ts` with `buildEnv()` creating proxies and `wireClassRefs()` connecting them to the loaded worker module. Added 16 tests covering fetch with Request/string/init, env passing, error cases, RPC on default export, RPC on named entrypoint, and wiring state. All 180 tests pass.

- **#06 cache-api**: Implemented `SqliteCache` and `SqliteCacheStorage` in `runtime/bindings/cache.ts`. `SqliteCache` uses the `cache_entries` table — `put()` stores response status, headers (JSON), and body (BLOB); `match()` reconstructs a `Response`; `delete()` removes the entry. Only GET requests are cacheable (unless `ignoreMethod: true`). Responses with `Set-Cookie` header are silently skipped on `put()`. `SqliteCacheStorage` exposes `default` (cache_name `"default"`) and `open(name)` for named caches. Named caches are isolated via the `cache_name` column. Global `caches` object registered in `plugin.ts` preload via `Object.defineProperty(globalThis, "caches", ...)`. Added 20 tests covering match, put, delete, ignoreMethod, Set-Cookie skip, binary body, headers preservation, named cache isolation, and persistence. All 241 tests pass.

- **#08 workflow-instance-management**: Extended `SqliteWorkflowBinding` with `createBatch()` for creating multiple instances at once. Added `sleepUntil(name, timestamp)` to `WorkflowStepImpl` — calculates delay from `Date.now()` to target timestamp, resolves immediately for past timestamps. Implemented `waitForEvent(name, options)` with dual mechanism: in-memory resolver registry for real-time delivery and `workflow_events` DB table for events sent before workflow reaches `waitForEvent`. Status transitions to `waiting` during `waitForEvent`, restored to `running` on resolution. `sendEvent({ type, payload })` added to `SqliteWorkflowInstance` — resolves in-memory waiter if present, otherwise stores in DB. Added `parseDuration()` helper for timeout strings (ms/s/m/h/d). Made step execution pause-aware: `checkPaused()` polls DB for `paused` status before each step, blocking until resumed or terminated. Added `workflow_events` table to `runMigrations()`. Added 12 new tests covering createBatch, sleepUntil, waitForEvent/sendEvent (real-time, pre-stored, via get() handle, timeout, terminate during wait), and pause-aware execution. All 253 tests pass.

- **#09 images-binding**: Implemented `ImagesBinding` class in `runtime/bindings/images.ts` with minimal viable approach (passthrough). `info(stream)` reads the full stream, detects format from magic bytes (PNG, JPEG, GIF, WebP, AVIF, SVG), and parses dimensions from image headers — returns `{ width, height, format, fileSize }`. `input(stream)` returns a `LazyImageTransformer` that supports chainable `transform()` and `draw()` calls (no-ops with console warning in dev mode) and `output(options)` which returns the original image data as a `ReadableStream` with the requested content-type. Added `images` config to `WranglerConfig`. Wired in `env.ts`. Added 12 tests covering PNG/JPEG/GIF/SVG info parsing, unknown format rejection, passthrough output, chainable transforms, draw compositing, and output format. All 265 tests pass.

- **#13 do-misc**: Added `DurableObjectIdImpl.equals()` for comparing IDs. Added `blockConcurrencyWhile()` to `DurableObjectStateImpl` — stores a ready promise that the proxy stub awaits before forwarding any method calls. Added `newUniqueId()` to `DurableObjectNamespaceImpl` using `crypto.randomUUID()` (jurisdiction option ignored in dev). Added `getByName()` as shorthand for `idFromName()` + `get()`. Added `StorageOptions` interface (`allowConcurrency`, `allowUnconfirmed`, `noCache`) as no-op optional parameters on all storage methods (`get`, `put`, `delete`, `deleteAll`). Added 7 new tests covering equals, blockConcurrencyWhile (both direct and via proxy deferral), newUniqueId, getByName. All 272 tests pass.

- **#05 static-assets**: Implemented `StaticAssets` class in `runtime/bindings/static-assets.ts`. `fetch(request)` serves files from a configured directory using `Bun.file()`. Supports all 4 `html_handling` modes: `none` (exact match only), `auto-trailing-slash` (tries `/path`, `/path/index.html`, `/path.html`), `force-trailing-slash` (301 redirect to add `/`), `drop-trailing-slash` (301 redirect to remove `/`). Supports all 3 `not_found_handling` modes: `none` (plain 404), `404-page` (serves `/404.html` with 404 status), `single-page-application` (serves `/index.html` for all not-found paths). Path traversal prevented via `..` check and `path.resolve` validation. Content-Type set via `Bun.file().type`. Added `assets` config to `WranglerConfig`. Wired in `env.ts` — if `binding` is set, added to env; if not, stored in registry for auto-serving. In `dev.ts`, static assets served before worker fetch handler when no binding name is configured. Added 23 tests covering file serving, nested files, Content-Type, path traversal, all html_handling modes, all not_found_handling modes. All 221 tests pass.

- **#10 do-alarms**: Added `getAlarm()`, `setAlarm(scheduledTime)`, and `deleteAlarm()` to `SqliteDurableObjectStorage` — backed by the `do_alarms` table. `setAlarm()` accepts `number` (ms epoch) or `Date`, upserts a single alarm row per DO instance (only one alarm at a time). `DurableObjectNamespaceImpl` manages alarm timers: `_scheduleAlarmTimer()` sets a `setTimeout`, `_fireAlarm()` calls the DO's `alarm()` handler with `{ retryCount, isRetry }`. On handler error, retries up to 6 times with exponential backoff (2^n seconds). Alarm is cleared from DB before calling handler (matching CF behavior). `_restoreAlarms()` runs on `_setClass()` to re-schedule any persisted alarms (past-due ones fire immediately). Alarm callback wired via `_setAlarmCallback()` on storage so `setAlarm`/`deleteAlarm` automatically schedule/cancel timers. Added 14 tests covering storage methods, alarm firing, replacement, cancellation, retry with backoff, past-due restoration, and persistence. All 286 tests pass.

- **#11 do-websocket-support**: Added `WebSocketRequestResponsePair` class and exported from `cloudflare:workers` plugin. Added WebSocket Hibernation API methods to `DurableObjectStateImpl`: `acceptWebSocket(ws, tags?)` registers WebSocket with event listeners delegating to DO's `webSocketMessage`/`webSocketClose`/`webSocketError` handlers; `getWebSockets(tag?)` returns accepted WebSockets filtered by optional tag; `getTags(ws)` returns tags for a WebSocket; `setWebSocketAutoResponse(pair?)` / `getWebSocketAutoResponse()` for automatic ping/pong-style responses; `getWebSocketAutoResponseTimestamp(ws)` tracks last auto-response time; `setHibernatableWebSocketEventTimeout()` / `getHibernatableWebSocketEventTimeout()` are no-ops. Auto-response intercepts matching messages before handler and sends response directly. Closed WebSockets auto-removed from accepted set. `_doInstance` reference wired in `DurableObjectNamespaceImpl` for handler delegation. Added 18 tests covering all methods, tag filtering, auto-response, handler delegation, and close cleanup. All 304 tests pass.

- **#12 do-sql-storage**: Implemented `SqlStorageCursor` and `SqlStorage` classes in `runtime/bindings/durable-object.ts`. `SqlStorageCursor` implements the full cursor API: iterable via `for..of`, `next()` iterator protocol, `toArray()`, `one()` (throws if not exactly 1 row), `raw()` (arrays without column names), `columnNames`, `rowsRead`, `rowsWritten`. `SqlStorage` provides `exec(query, ...bindings)` which creates a per-DO-instance SQLite file at `.bunflare/do-sql/<namespace>/<id>.sqlite` with lazy initialization and WAL mode. Distinguishes SELECT/WITH/PRAGMA (returns rows) from write statements (returns changes count). `databaseSize` returns file size via `statSync`. `SqliteDurableObjectStorage.sql` getter lazily creates `SqlStorage` when `dataDir` is configured. Extended constructor chain: `SqliteDurableObjectStorage(db, namespace, id, dataDir?)`, `DurableObjectStateImpl(id, db, namespace, dataDir?)`, `DurableObjectNamespaceImpl(db, name, dataDir?)`. Updated `env.ts` to pass `getDataDir()`. Added `migrations` field to `WranglerConfig`. Added 18 tests covering exec, columnNames, iteration, next(), one(), raw(), rowsRead/rowsWritten, databaseSize, parameter bindings, instance isolation, persistence, and namespace integration. All 322 tests pass.

- **#27 do-gaps**: Added `stub.fetch(request)` — proxy intercepts `fetch` property and calls the DO's `fetch()` handler, constructing a proper `Request` from string/URL inputs. Added `stub.id` and `stub.name` properties on the proxy stub. Added `list({ startAfter })` — exclusive start key (key > startAfter), takes precedence over `start` when both provided. Added `sync()` as no-op returning resolved promise. Added `DurableObjectLimits` interface with configurable WebSocket validation: `maxTagsPerWebSocket` (default 10), `maxTagLength` (default 256), `maxConcurrentWebSockets` (default 32,768), `maxAutoResponseLength` (default 2,048). Limits passed through `DurableObjectNamespaceImpl` → `DurableObjectStateImpl`. Fixed `setHibernatableWebSocketEventTimeout`/`getHibernatableWebSocketEventTimeout` to store and return the value instead of being no-ops. Added 19 new tests. All 341 tests pass.

- **#18 kv-gaps**: Added `KVLimits` interface with configurable `maxKeySize` (512), `maxValueSize` (25 MiB), `maxMetadataSize` (1024), `minTtlSeconds` (60), `maxBulkGetKeys` (100) — passed via constructor. Key validation rejects empty strings, `.`, `..`, and keys exceeding max byte size. Value size validated after encoding. Metadata size validated after JSON serialization. `expirationTtl` validated against minimum. Added bulk `get(keys[])` returning `Map<string, value>` and bulk `getWithMetadata(keys[])` returning `Map<string, {value, metadata}>` with IN-query batching and expired key cleanup. `cacheTtl` option accepted and ignored on `get()`/`getWithMetadata()`. Added 20 new tests (44 total KV tests). All 362 tests pass.

- **#21 queues-gaps**: Fixed content type handling — `bytes` now stores/retrieves `ArrayBuffer`/`Uint8Array` as binary BLOB (changed `body` column from TEXT to BLOB), `v8` uses JSON serialization as structured-clone approximation, `text` properly encodes/decodes via `TextEncoder`/`TextDecoder`. Added `QueueLimits` interface with configurable `maxMessageSize` (128 KB), `maxBatchMessages` (100), `maxBatchSize` (256 KB), `maxDelaySeconds` (43200) — passed via constructor. Validation on `send()`: message size, delay range. Validation on `sendBatch()`: message count, individual message size, total batch size, delay range. Fixed `message.attempts` to be 0 on first delivery (counting previous attempts, matching CF behavior). `ctx.waitUntil()` now tracks promises and awaits them via `Promise.allSettled` after handler completes. Added 15 new tests (33 total queue tests). All 386 tests pass.

- **#20 d1-gaps**: Added `dump()` method using `db.serialize()` to export the database as an ArrayBuffer. Replaced naive `exec()` semicolon splitting with a proper SQL statement splitter (`splitStatements()`) that respects single-quoted and double-quoted strings (including escaped quotes `''`/`""`), line comments (`--`), and block comments (`/* */`). Added type conversion in `bind()`: `undefined` throws `D1_TYPE_ERROR`, `boolean` converts to `0`/`1`, `ArrayBuffer` converts to `Uint8Array` for BLOB storage. Improved meta accuracy: `rows_read` now reflects the number of rows returned by SELECT queries, `rows_written` now reflects `changes()` for write statements (INSERT/UPDATE/DELETE). Added 12 new tests (30 total D1 tests). All 374 tests pass.

- **#23 cache-api-gaps**: Added `expires_at` column to `cache_entries` table. `put()` now parses `Cache-Control` header (`max-age`, `s-maxage`, `no-store`) and `Expires` header as fallback, storing computed expiration timestamp. `s-maxage` takes precedence over `max-age` (shared cache behavior). `no-store` responses silently skipped (not cached). `match()` checks expiration and lazily deletes expired entries from DB. `match()` adds `cf-cache-status: HIT` header on cache hits. Added validation: `put()` rejects 206 Partial Content responses and `Vary: *` responses. Added `CacheLimits` interface with configurable `maxBodySize` (default 512 MiB) and `maxHeaderSize` (default 32 KiB) — passed via constructor. `SqliteCacheStorage` forwards limits to all caches. Added 14 new tests (34 total cache tests). All 400 tests pass.

- **#26 workflows-gaps**: Added `WorkflowStepConfig` interface with `retries` (`limit`, `delay`, `backoff`: constant/linear/exponential) and `timeout`. `step.do(name, config, callback)` overload now supports retry with configurable backoff and per-step timeout via `Promise.race`. Added `NonRetryableError` class (exported from both `workflow.ts` and `cloudflare:workflows` plugin) — when thrown, skips all retries. Implemented step checkpointing: `workflow_steps` table caches step results by `(instance_id, step_name)`; on workflow restart, cached results are replayed instead of re-executing. `restart()` clears cached steps. `status()` now returns structured error `{ name, message }` instead of plain string. Added `queued` status: when `WorkflowLimits.maxConcurrentInstances` is set, new instances beyond the limit get `queued` status and start automatically when running instances complete. `waitForEvent` now returns `{ payload, timestamp, type }` (WorkflowStepEvent structure). Added `retention` support: `WorkflowLimits.maxRetentionMs` auto-deletes completed/errored instances on next `create()`. Updated `plugin.ts` to use exported `NonRetryableError`. Added 13 new tests (40 total workflow tests). All 413 tests pass.

- **#19 r2-gaps**: Added `R2Limits` interface with configurable `maxKeySize` (1024), `maxCustomMetadataSize` (2048), `maxBatchDeleteKeys` (1000), `maxMultipartParts` (10000) — passed via constructor. Key size validation on `put()` and `createMultipartUpload()`. Custom metadata size validation after JSON serialization. Batch delete count validation. Added `version` (UUID), `httpEtag` (quoted etag), `checksums` (R2Checksums with md5 auto-generated), `storageClass` ("Standard"), `writeHttpMetadata(headers)`, and `blob()` to R2Object/R2ObjectBody. Implemented `onlyIf` conditional on `get()` (returns R2Object without body on condition failure) and `put()` (returns null on failure) — supports `etagMatches`, `etagDoesNotMatch`, `uploadedBefore`, `uploadedAfter`. Implemented range reads on `get()` with `{ offset, length }` and `{ suffix }` — returned object includes `range` property. Added `delimiter` to `list()` returning `delimitedPrefixes` for hierarchical key grouping. Added `include` option to filter `httpMetadata`/`customMetadata` in list results. Implemented multipart upload: `createMultipartUpload()`, `resumeMultipartUpload()`, `R2MultipartUpload` with `uploadPart()`, `complete()`, `abort()` — parts stored as temp files, assembled on complete. Added `r2_multipart_uploads` and `r2_multipart_parts` tables. Added `version` and `checksums` columns to `r2_objects`. Added 28 new tests (55 total R2 tests). All 442 tests pass.

- **#24 static-assets-gaps**: Added `ETag` header (based on mtime+size) and `Cache-Control: public, max-age=0, must-revalidate` to all served responses. `If-None-Match` conditional requests return 304 when ETag matches. Implemented `_headers` file parsing with support for splats (`*`) and placeholders (`:name`), limited to 100 rules and 2000 chars per line via `StaticAssetsLimits`. Changed redirect status from 301 to 307 for `force-trailing-slash` and `drop-trailing-slash` modes (matching CF behavior). Added `run_worker_first` config option (boolean or array of route patterns) — when true/matching, worker fetch handler runs first with asset fallback; default remains assets-first. Implemented hierarchical `404.html` lookup in `404-page` mode — searches up the directory tree from the requested path. Added `StaticAssetsLimits` interface with configurable `maxHeaderRules` and `maxHeaderLineLength`. Added 16 new tests (39 total static-assets tests). All 458 tests pass.

- **#22 service-bindings-gaps**: RPC property access now returns thenables — `await binding.prop` reads a property from the target, `await binding.method(args)` calls it. All RPC returns wrapped in `Promise.resolve()` for async consistency (matching CF behavior where everything crosses a process boundary). Added `ServiceBindingLimits` with configurable `maxSubrequests` (default 1000) and `maxRpcPayloadSize` (default 32 MiB). Subrequest count tracked across both `fetch()` and RPC calls. `connect()` stub throws with clear error. Promise protocol safety: proxy's own `then`/`catch`/`finally` return `undefined` so the proxy itself is not auto-unwrapped. Request/Response/ReadableStream pass through as RPC arguments (in-process, no serialization needed). Added 15 new tests (31 total service binding tests). All 473 tests pass.

- **#28 config-gaps**: Added lightweight TOML parser in `config.ts` supporting key/value pairs, basic/literal strings, numbers, booleans, arrays, inline tables, tables, and array of tables — enough for wrangler.toml configs. Added `autoLoadConfig(baseDir)` that auto-detects config format: tries `wrangler.jsonc`, then `wrangler.json`, then `wrangler.toml`. Added environment-specific config: `env` field in WranglerConfig with `[env.<name>]` sections (TOML) or `"env": { "<name>": {} }` (JSON); `--env <name>` CLI flag in `dev.ts` selects environment; env-specific values override top-level config. Added `compatibility_date` and `compatibility_flags` to WranglerConfig (parsed and accepted, not enforced). Added `.env` file support as fallback when `.dev.vars` doesn't exist — `.dev.vars` takes priority (matching CF behavior). `buildEnv()` now accepts a directory path and auto-detects `.dev.vars`/`.env`. Added `env` export to `cloudflare:workers` plugin via getter on `globalEnv` — `import { env } from "cloudflare:workers"` works. Fixed JSONC comment stripping to respect string literals (no longer breaks URLs with `//`). Added 27 new tests (30 total config tests, 15 total env-vars tests). All 500 tests pass.

- **#29 scheduled-gaps**: Added special cron string aliases (`@daily`/`@midnight`, `@hourly`, `@weekly`, `@monthly`, `@yearly`/`@annually`) — resolved to standard 5-field expressions before parsing, with original alias preserved in `expression` field. Added day-of-week names (`MON`–`SUN`) and month names (`JAN`–`DEC`) support in cron fields — case-insensitive, works in single values, ranges, and comma-separated lists. Added `type: "scheduled"` property to `ScheduledController` interface and `createScheduledController()`. Added 18 new tests (36 total scheduled tests). All 518 tests pass.

- **#25 images-transforms**: Replaced passthrough image transformer with Sharp-based implementation. `transform()` now applies resize (`width`/`height` with `fit` mapping to Sharp equivalents), `rotate` (0/90/180/270), `flip`, `flop`, `blur`, `sharpen`, and `brightness`. Each transform step runs as a separate Sharp pipeline to ensure correct operation ordering (Sharp internally reorders operations within a single pipeline). `draw()` now composites overlays via Sharp's `composite()` with support for `top`/`left`/`bottom`/`right` positioning and `repeat` tiling. `output()` applies format conversion (PNG/JPEG/WebP/AVIF) with configurable `quality`. Added `DrawOptions.bottom`, `DrawOptions.right`, and `DrawOptions.repeat` fields. Implemented AVIF/HEIF dimension parsing in `info()` by scanning for the `ispe` (ImageSpatialExtentsProperty) box in the ISOBMFF container, with Sharp metadata as fallback. Added `sharp` as a dependency. Added 11 new tests (23 total images tests) covering AVIF dimensions, resize, rotate, format conversion, quality, draw compositing, tiling, and combined transforms. All 529 tests pass.

- **#30 html-rewriter**: Implemented `HTMLRewriter` class in `runtime/bindings/html-rewriter.ts` wrapping `html-rewriter-wasm` (WASM port of Cloudflare's lol-html). `on(selector, handler)` registers element handlers with full CSS selector support (tag, class, id, attribute selectors, combinators, pseudo-classes). `onDocument(handler)` registers document-level handlers (doctype, comments, text, end). `transform(response)` returns a new `Response` with streaming HTML transformation via `TransformStream` — reads chunks from the original response body, pipes through the WASM rewriter, and writes transformed chunks to the output stream. Content-length header removed since streaming transform changes body size. Null body responses passed through as-is. Registered `HTMLRewriter` on `globalThis` in `plugin.ts`. Added `html-rewriter-wasm` dependency. Added 35 tests covering element operations (getAttribute, setAttribute, removeAttribute, hasAttribute, tagName, attributes iterator, setInnerContent, before/after, prepend/append, replace, remove, removeAndKeepContent), end tag handlers, text handlers (chunks, replace, remove, lastInTextNode), comment handlers (read, modify, remove, replace), document handlers (doctype, end append, text, comments), CSS selectors (class, id, attribute value, wildcard), chaining multiple handlers, and transform behavior (status/headers preservation, content-length removal, null body, large HTML). All 564 tests pass.

- **#31 websocket-pair**: Implemented `WebSocketPair` and `CFWebSocket` classes in `runtime/bindings/websocket-pair.ts`. `WebSocketPair` constructor creates two linked in-memory WebSocket-like objects accessible via numeric keys (`pair[0]`, `pair[1]`) and `Object.values()`. `CFWebSocket` extends `EventTarget` with CF-specific `accept()` method — events are buffered until `accept()` is called. Supports `send()` (string, ArrayBuffer, ArrayBufferView), `close(code?, reason?)`, `readyState` transitions (CONNECTING→OPEN→CLOSED), `addEventListener()` and `on*` callback-style handlers. Messages sent on one socket are delivered to the peer. Close propagates bidirectionally. Registered `WebSocketPair` on `globalThis` and exported from `cloudflare:workers` plugin. In `dev.ts`, added WebSocket upgrade bridge: when worker returns `Response(null, { status: 101, webSocket: client })`, Bun's native WebSocket upgrade bridges the real client connection to the CFWebSocket pair — real client messages forwarded to the server-side CFWebSocket, server-side sends forwarded to the real client. Added 22 tests covering constructor, Object.values destructuring, readyState constants/transitions, accept() gating, bidirectional string/binary messaging, ArrayBufferView support, event buffering until accept(), close propagation, close idempotency, callback-style handlers, multiple listeners, upgrade response pattern, and buffered close flush. All 586 tests pass.

- **#32 cf-streams**: Implemented `IdentityTransformStream` (extends `TransformStream`, byte passthrough) and `FixedLengthStream` (enforces exact byte count — errors on over-write via `controller.error()` in `transform()`, errors on under-write via `controller.error()` in `flush()`). `FixedLengthStream` constructor accepts `number` or `bigint`, exposes `expectedLength` property. Both classes registered on `globalThis` in `plugin.ts`. Added 17 tests covering passthrough, multi-chunk, pipeTo, binary data, exact length, over-length error, under-length error, bigint, zero length, Response body usage, and instanceof checks. All 682 pre-existing tests still pass (1 pre-existing failure in db.test.ts unrelated to this change).

- **#33 do-sync-kv**: Added `SyncKV` class in `runtime/bindings/durable-object.ts` with synchronous `get(key)`, `put(key, value)`, `delete(key)` (returns boolean), and `list(options?)` (generator yielding `[key, value]` tuples). Uses the same `do_storage` SQLite table as the async API — full interop between sync and async methods. Lazy `kv` getter added to `SqliteDurableObjectStorage`. `list()` supports `prefix`, `start`, `startAfter`, `end`, `reverse`, and `limit` options. Added 16 new tests (137 total DO tests) covering basic CRUD, overwrite, delete return values, list with all options, async/sync interop, instance caching, and access via `DurableObjectStateImpl`. All 697 tests pass.

- **#34 redirects-file**: Implemented `_redirects` file support in `runtime/bindings/static-assets.ts`. Added `parseRedirects(content, limits)` parser: one rule per line (`<from> <to> [status]`), default status 302, comments/empty lines ignored, invalid status codes skipped. Added `matchRedirectPattern(pattern, pathname)` returning captured groups (`splat` for `*`, named for `:param`). Redirect rules checked first in `fetch()` (highest precedence, before `_headers` and asset matching). 3xx status codes return `Response` with `Location` header. 200 status rewrites the path internally (transparent proxy). Added `StaticAssetsLimits.maxStaticRedirects` (default 2000) and `maxDynamicRedirects` (default 100) — static rules have no wildcards/placeholders, dynamic rules do. Added 21 new tests (60 total static-assets tests) covering `parseRedirects` (status codes, comments, dynamic detection, limits), `matchRedirectPattern` (exact, splat, placeholder), and integration tests (301/302/303/307/308, splats, placeholders, 200 rewrite, first-match-wins, precedence over assets, query string preservation). All 718 tests pass.

- **#36 navigator-globals**: Set `navigator.userAgent` to `"Cloudflare-Workers"` and `navigator.language` to `"en"` via `Object.defineProperty` on `globalThis.navigator` in `plugin.ts`. Set `performance.timeOrigin` to `0` (matching CF semantics where timeOrigin is always 0). Registered `scheduler.wait(ms)` on `globalThis` — returns a `Promise<void>` that resolves after `ms` milliseconds via `setTimeout`. Added 6 tests covering userAgent value, language default, timeOrigin, performance.now(), scheduler.wait delay, and scheduler.wait(0). All 741 tests pass (1 pre-existing workflow failure unrelated).

- **#35 crypto-extras**: Implemented `crypto.subtle.timingSafeEqual(a, b)` using `node:crypto`'s `timingSafeEqual` (Bun-supported). Accepts `ArrayBuffer` or `ArrayBufferView`, throws `TypeError` on mismatched lengths, returns `boolean`. Implemented `DigestStream` extending `WritableStream` — constructor takes algorithm name (`SHA-1`, `SHA-256`, `SHA-384`, `SHA-512`, `MD5`), internally uses `Bun.CryptoHasher`. `digest` property is a `Promise<ArrayBuffer>` resolving on stream close. Supports case-insensitive algorithm names. Both registered on `globalThis.crypto` via `patchGlobalCrypto()` in `plugin.ts`. Added 17 tests covering equal/different/empty buffers, ArrayBufferView/DataView/subarray inputs, SHA-256/SHA-1/SHA-512/MD5 hashes, multiple chunks, pipeTo, empty input, unsupported algorithm, and case-insensitive algorithm names. All 735 tests pass (1 pre-existing workflow failure unrelated).

- **#37 queue-pull-consumers**: Implemented `QueuePullConsumer` class in `runtime/bindings/queue.ts` with `pull()` and `ack()` methods. `pull(options?)` selects visible messages without active leases, generates a UUID `lease_id` per message, stores leases in a `queue_leases` table with expiration timestamp, increments message attempts, and returns messages with `lease_id`, `id`, `timestamp`, `body`, `attempts`. Expired leases are cleaned up on each `pull()` call, making messages visible again after visibility timeout. `v8` content type messages are filtered out (not supported by pull consumers). `ack(request)` processes `acks` (delete message + lease) and `retries` (update `visible_at` + delete lease) — expired leases are ignored. Added HTTP routes in `dev.ts`: `POST /__queues/<name>/messages/pull` and `POST /__queues/<name>/messages/ack`. Added `queue_leases` table to `runMigrations()`. Added 12 new tests (49 total queue tests) covering pull with lease, invisibility window, ack, retry with delay, visibility timeout expiration, v8 rejection, batch_size, expired lease handling, mixed ack/retry, attempts tracking, and content type decoding. All 753 tests pass (1 pre-existing workflow failure unrelated).

- **#38 do-transaction-sync**: Added `transactionSync<T>(callback: () => T): T` to `SqliteDurableObjectStorage`. Uses `BEGIN IMMEDIATE` / `COMMIT` / `ROLLBACK` for synchronous atomic transactions. Works with `storage.kv.*` and `storage.sql.*` operations. On exception, rolls back all changes and re-throws. Returns the callback's return value. Added 5 tests covering basic commit, rollback on exception, return value propagation, nested read/write atomicity, and sql interop. All 758 tests pass (1 pre-existing workflow failure unrelated).

## Lessons Learned

- `Bun.plugin()` with `build.module()` is the way to shim `cloudflare:*` imports — `onResolve`/`onLoad` doesn't work for the `cloudflare:` scheme because Bun rejects it as an invalid URL before the plugin can intercept
- `bun:sqlite` `Database` class is synchronous — no need for `await` on queries
- R2 blobs should be stored as files on disk, not in SQLite (avoids bloating the database)
- When changing a binding class (rename, new constructor params), always update the corresponding test file in `runtime/tests/` AND `runtime/env.ts`
- `runtime/config.ts` has a `WranglerConfig` interface — when adding a new binding type, extend this interface with the new config fields
- For workflow `waitForEvent`/`sendEvent`, use an in-memory registry of promise resolvers (per-process) combined with a `workflow_events` DB table for events sent before the workflow reaches `waitForEvent`. This handles both timing scenarios correctly.
- Naive JSONC comment stripping (`/\/\/.*$/gm`) breaks URLs inside JSON strings (e.g. `https://...`). Use a proper state-machine parser that tracks whether you're inside a string literal before stripping `//` comments.
- Sharp internally reorders operations within a single pipeline (e.g. `rotate` runs before `resize`). To ensure sequential ordering of transforms, run each transform as a separate Sharp pipeline by calling `toBuffer()` between them.
